!function(n,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("@angular/core"),require("@angular/forms"),require("@angular/router"),require("@biesbjerg/ngx-translate-extract-marker"),require("@vendure/admin-ui/core"),require("rxjs/operators"),require("rxjs")):"function"==typeof define&&define.amd?define("@vendure/admin-ui/marketing",["exports","@angular/core","@angular/forms","@angular/router","@biesbjerg/ngx-translate-extract-marker","@vendure/admin-ui/core","rxjs/operators","rxjs"],r):r(((n="undefined"!=typeof globalThis?globalThis:n||self).vendure=n.vendure||{},n.vendure["admin-ui"]=n.vendure["admin-ui"]||{},n.vendure["admin-ui"].marketing={}),n.ng.core,n.ng.forms,n.ng.router,n.ngxTranslateExtractMarker,n.vendure["admin-ui"].core,n.rxjs.operators,n.rxjs)}(this,(function(n,r,t,e,o,i,a,c){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var s=function(n,r){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,r){n.__proto__=r}||function(n,r){for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&(n[t]=r[t])})(n,r)};function d(n,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function t(){this.constructor=n}s(n,r),n.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)}Object.create;function l(n,r){var t="function"==typeof Symbol&&n[Symbol.iterator];if(!t)return n;var e,o,i=t.call(n),a=[];try{for(;(void 0===r||r-- >0)&&!(e=i.next()).done;)a.push(e.value)}catch(n){o={error:n}}finally{try{e&&!e.done&&(t=i.return)&&t.call(i)}finally{if(o)throw o.error}}return a}function m(){for(var n=[],r=0;r<arguments.length;r++)n=n.concat(l(arguments[r]));return n}Object.create;var u=function(n){function r(r,e,o,i,a,c,s){var d=n.call(this,e,r,o,a)||this;return d.changeDetector=i,d.dataService=a,d.formBuilder=c,d.notificationService=s,d.conditions=[],d.actions=[],d.allConditions=[],d.allActions=[],d.detailForm=d.formBuilder.group({name:["",t.Validators.required],enabled:!0,couponCode:null,perCustomerUsageLimit:null,startsAt:null,endsAt:null,conditions:d.formBuilder.array([]),actions:d.formBuilder.array([])}),d}return d(r,n),r.prototype.ngOnInit=function(){var n=this;this.init(),this.promotion$=this.entity$,this.dataService.promotion.getPromotionActionsAndConditions().single$.subscribe((function(r){n.allActions=r.promotionActions,n.allConditions=r.promotionConditions,n.changeDetector.markForCheck()}))},r.prototype.ngOnDestroy=function(){this.destroy()},r.prototype.getAvailableConditions=function(){var n=this;return this.allConditions.filter((function(r){return!n.conditions.find((function(n){return n.code===r.code}))}))},r.prototype.getConditionDefinition=function(n){return this.allConditions.find((function(r){return r.code===n.code}))},r.prototype.getAvailableActions=function(){var n=this;return this.allActions.filter((function(r){return!n.actions.find((function(n){return n.code===r.code}))}))},r.prototype.getActionDefinition=function(n){return this.allActions.find((function(r){return r.code===n.code}))},r.prototype.saveButtonEnabled=function(){return this.detailForm.dirty&&this.detailForm.valid&&(0!==this.conditions.length||this.detailForm.value.couponCode)&&0!==this.actions.length},r.prototype.addCondition=function(n){this.addOperation("conditions",n),this.detailForm.markAsDirty()},r.prototype.addAction=function(n){this.addOperation("actions",n),this.detailForm.markAsDirty()},r.prototype.removeCondition=function(n){this.removeOperation("conditions",n),this.detailForm.markAsDirty()},r.prototype.removeAction=function(n){this.removeOperation("actions",n),this.detailForm.markAsDirty()},r.prototype.formArrayOf=function(n){return this.detailForm.get(n)},r.prototype.create=function(){var n=this;if(this.detailForm.dirty){var r=this.detailForm.value,t={name:r.name,enabled:!0,couponCode:r.couponCode,perCustomerUsageLimit:r.perCustomerUsageLimit,startsAt:r.startsAt,endsAt:r.endsAt,conditions:this.mapOperationsToInputs(this.conditions,r.conditions),actions:this.mapOperationsToInputs(this.actions,r.actions)};this.dataService.promotion.createPromotion(t).subscribe((function(r){var t=r.createPromotion;switch(t.__typename){case"Promotion":n.notificationService.success(o.marker("common.notify-create-success"),{entity:"Promotion"}),n.detailForm.markAsPristine(),n.changeDetector.markForCheck(),n.router.navigate(["../",t.id],{relativeTo:n.route});break;case"MissingConditionsError":n.notificationService.error(t.message)}}),(function(r){n.notificationService.error(o.marker("common.notify-create-error"),{entity:"Promotion"})}))}},r.prototype.save=function(){var n=this;if(this.detailForm.dirty){var r=this.detailForm.value;this.promotion$.pipe(a.take(1),a.mergeMap((function(t){var e={id:t.id,name:r.name,enabled:r.enabled,couponCode:r.couponCode,perCustomerUsageLimit:r.perCustomerUsageLimit,startsAt:r.startsAt,endsAt:r.endsAt,conditions:n.mapOperationsToInputs(n.conditions,r.conditions),actions:n.mapOperationsToInputs(n.actions,r.actions)};return n.dataService.promotion.updatePromotion(e)}))).subscribe((function(r){n.notificationService.success(o.marker("common.notify-update-success"),{entity:"Promotion"}),n.detailForm.markAsPristine(),n.changeDetector.markForCheck()}),(function(r){n.notificationService.error(o.marker("common.notify-update-error"),{entity:"Promotion"})}))}},r.prototype.setFormValues=function(n,r){var t=this;this.detailForm.patchValue({name:n.name,enabled:n.enabled,couponCode:n.couponCode,perCustomerUsageLimit:n.perCustomerUsageLimit,startsAt:n.startsAt,endsAt:n.endsAt}),n.conditions.forEach((function(n){t.addOperation("conditions",n)})),n.actions.forEach((function(n){return t.addOperation("actions",n)}))},r.prototype.mapOperationsToInputs=function(n,r){return n.map((function(n,t){return{code:n.code,arguments:Object.values(r[t].args).map((function(r,t){return{name:n.args[t].name,value:i.encodeConfigArgValue(r)}}))}}))},r.prototype.addOperation=function(n,r){var t=this,e=this.formArrayOf(n),o="conditions"===n?this.conditions:this.actions;if(-1===e.value.findIndex((function(n){return n.code===r.code}))){var a=r.args.reduce((function(e,o){var a,c;return Object.assign(Object.assign({},e),((a={})[o.name]=null!==(c=i.getConfigArgValue(o.value))&&void 0!==c?c:t.getDefaultArgValue(n,r,o.name),a))}),{});e.push(this.formBuilder.control({code:r.code,args:a})),o.push({code:r.code,args:r.args.map((function(n){return{name:n.name,value:i.getConfigArgValue(n.value)}}))})}},r.prototype.getDefaultArgValue=function(n,r,t){var e="conditions"===n?this.allConditions.find((function(n){return n.code===r.code})):this.allActions.find((function(n){return n.code===r.code}));if(e){var o=e.args.find((function(n){return n.name===t}));if(o)return i.getDefaultConfigArgValue(o)}throw new Error('Could not determine default value for "argName"')},r.prototype.removeOperation=function(n,r){var t=this.formArrayOf(n),e="conditions"===n?this.conditions:this.actions,o=t.value.findIndex((function(n){return n.code===r.code}));-1!==o&&(t.removeAt(o),e.splice(o,1))},r}(i.BaseDetailComponent);u.decorators=[{type:r.Component,args:[{selector:"vdr-promotion-detail",template:'<vdr-action-bar>\r\n    <vdr-ab-left>\r\n        <div class="flex clr-align-items-center">\r\n            <vdr-entity-info [entity]="entity$ | async"></vdr-entity-info>\r\n            <clr-toggle-wrapper *vdrIfPermissions="\'UpdatePromotion\'">\r\n                <input type="checkbox" clrToggle name="enabled" [formControl]="detailForm.get([\'enabled\'])" />\r\n                <label>{{ \'common.enabled\' | translate }}</label>\r\n            </clr-toggle-wrapper>\r\n        </div>\r\n    </vdr-ab-left>\r\n\r\n    <vdr-ab-right>\r\n        <vdr-action-bar-items locationId="promotion-detail"></vdr-action-bar-items>\r\n        <button\r\n            class="btn btn-primary"\r\n            *ngIf="isNew$ | async; else updateButton"\r\n            (click)="create()"\r\n            [disabled]="!saveButtonEnabled()"\r\n        >\r\n            {{ \'common.create\' | translate }}\r\n        </button>\r\n        <ng-template #updateButton>\r\n            <button\r\n                class="btn btn-primary"\r\n                (click)="save()"\r\n                *vdrIfPermissions="\'UpdatePromotion\'"\r\n                [disabled]="!saveButtonEnabled()"\r\n            >\r\n                {{ \'common.update\' | translate }}\r\n            </button>\r\n        </ng-template>\r\n    </vdr-ab-right>\r\n</vdr-action-bar>\r\n\r\n<form class="form" [formGroup]="detailForm">\r\n    <vdr-form-field [label]="\'common.name\' | translate" for="name">\r\n        <input\r\n            id="name"\r\n            [readonly]="!(\'UpdatePromotion\' | hasPermission)"\r\n            type="text"\r\n            formControlName="name"\r\n        />\r\n    </vdr-form-field>\r\n    <vdr-form-field [label]="\'marketing.starts-at\' | translate" for="startsAt">\r\n        <vdr-datetime-picker formControlName="startsAt"></vdr-datetime-picker>\r\n    </vdr-form-field>\r\n    <vdr-form-field [label]="\'marketing.ends-at\' | translate" for="endsAt">\r\n        <vdr-datetime-picker formControlName="endsAt"></vdr-datetime-picker>\r\n    </vdr-form-field>\r\n    <vdr-form-field [label]="\'marketing.coupon-code\' | translate" for="couponCode">\r\n        <input\r\n            id="couponCode"\r\n            [readonly]="!(\'UpdatePromotion\' | hasPermission)"\r\n            type="text"\r\n            formControlName="couponCode"\r\n        />\r\n    </vdr-form-field>\r\n    <vdr-form-field [label]="\'marketing.per-customer-limit\' | translate" for="perCustomerUsageLimit">\r\n        <input\r\n            id="perCustomerUsageLimit"\r\n            [readonly]="!(\'UpdatePromotion\' | hasPermission)"\r\n            type="number"\r\n            min="1"\r\n            max="999"\r\n            formControlName="perCustomerUsageLimit"\r\n        />\r\n    </vdr-form-field>\r\n\r\n    <div class="clr-row">\r\n        <div class="clr-col" formArrayName="conditions">\r\n            <label class="clr-control-label">{{ \'marketing.conditions\' | translate }}</label>\r\n            <ng-container *ngFor="let condition of conditions; index as i">\r\n                <vdr-configurable-input\r\n                    (remove)="removeCondition($event)"\r\n                    [readonly]="!(\'UpdatePromotion\' | hasPermission)"\r\n                    [operation]="condition"\r\n                    [operationDefinition]="getConditionDefinition(condition)"\r\n                    [formControlName]="i"\r\n                ></vdr-configurable-input>\r\n            </ng-container>\r\n\r\n            <div>\r\n                <vdr-dropdown *vdrIfPermissions="\'UpdatePromotion\'">\r\n                    <button class="btn btn-outline" vdrDropdownTrigger>\r\n                        <clr-icon shape="plus"></clr-icon>\r\n                        {{ \'marketing.add-condition\' | translate }}\r\n                    </button>\r\n                    <vdr-dropdown-menu vdrPosition="bottom-left">\r\n                        <button\r\n                            *ngFor="let condition of getAvailableConditions()"\r\n                            type="button"\r\n                            vdrDropdownItem\r\n                            (click)="addCondition(condition)"\r\n                        >\r\n                            {{ condition.description }}\r\n                        </button>\r\n                    </vdr-dropdown-menu>\r\n                </vdr-dropdown>\r\n            </div>\r\n        </div>\r\n        <div class="clr-col" formArrayName="actions">\r\n            <label class="clr-control-label">{{ \'marketing.actions\' | translate }}</label>\r\n            <vdr-configurable-input\r\n                *ngFor="let action of actions; index as i"\r\n                (remove)="removeAction($event)"\r\n                [operation]="action"\r\n                [readonly]="!(\'UpdatePromotion\' | hasPermission)"\r\n                [operationDefinition]="getActionDefinition(action)"\r\n                [formControlName]="i"\r\n            ></vdr-configurable-input>\r\n            <div>\r\n                <vdr-dropdown *vdrIfPermissions="\'UpdatePromotion\'">\r\n                    <button class="btn btn-outline" vdrDropdownTrigger>\r\n                        <clr-icon shape="plus"></clr-icon>\r\n                        {{ \'marketing.add-action\' | translate }}\r\n                    </button>\r\n                    <vdr-dropdown-menu vdrPosition="bottom-left">\r\n                        <button\r\n                            *ngFor="let action of getAvailableActions()"\r\n                            type="button"\r\n                            vdrDropdownItem\r\n                            (click)="addAction(action)"\r\n                        >\r\n                            {{ action.description }}\r\n                        </button>\r\n                    </vdr-dropdown-menu>\r\n                </vdr-dropdown>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</form>\r\n',changeDetection:r.ChangeDetectionStrategy.OnPush,styles:[""]}]}],u.ctorParameters=function(){return[{type:e.Router},{type:e.ActivatedRoute},{type:i.ServerConfigService},{type:r.ChangeDetectorRef},{type:i.DataService},{type:t.FormBuilder},{type:i.NotificationService}]};var p=function(n){function r(r,e,o,i,a){var c=n.call(this,e,o)||this;return c.dataService=r,c.notificationService=i,c.modalService=a,c.searchForm=new t.FormGroup({name:new t.FormControl(""),couponCode:new t.FormControl("")}),n.prototype.setQueryFn.call(c,(function(){for(var n,r=[],t=0;t<arguments.length;t++)r[t]=arguments[t];return(n=c.dataService.promotion).getPromotions.apply(n,m(r)).refetchOnChannelChange()}),(function(n){return n.promotions}),(function(n,r){return c.createQueryOptions(n,r,c.searchForm.value)})),c}return d(r,n),r.prototype.ngOnInit=function(){var r=this;n.prototype.ngOnInit.call(this),c.merge(this.searchForm.valueChanges.pipe(a.debounceTime(250)),this.route.queryParamMap).pipe(a.takeUntil(this.destroy$)).subscribe((function(n){n.params||r.setPageNumber(1),r.refresh()}))},r.prototype.deletePromotion=function(n){var r=this;this.modalService.dialog({title:o.marker("catalog.confirm-delete-promotion"),buttons:[{type:"secondary",label:o.marker("common.cancel")},{type:"danger",label:o.marker("common.delete"),returnValue:!0}]}).pipe(a.switchMap((function(t){return t?r.dataService.promotion.deletePromotion(n):c.EMPTY}))).subscribe((function(){r.notificationService.success(o.marker("common.notify-delete-success"),{entity:"Promotion"}),r.refresh()}),(function(n){r.notificationService.error(o.marker("common.notify-delete-error"),{entity:"Promotion"})}))},r.prototype.createQueryOptions=function(n,r,t){var e={};return t.couponCode&&(e.couponCode={contains:t.couponCode}),t.name&&(e.name={contains:t.name}),{options:{skip:n,take:r,filter:e}}},r}(i.BaseListComponent);p.decorators=[{type:r.Component,args:[{selector:"vdr-promotion-list",template:'<vdr-action-bar>\r\n    <vdr-ab-left>\r\n        <form class="search-form" [formGroup]="searchForm">\r\n            <input\r\n                type="text"\r\n                formControlName="name"\r\n                [placeholder]="\'marketing.search-by-name\' | translate"\r\n                class="search-input"\r\n            />\r\n            <input\r\n                type="text"\r\n                formControlName="couponCode"\r\n                [placeholder]="\'marketing.search-by-coupon-code\' | translate"\r\n                class="search-input"\r\n            />\r\n        </form>\r\n    </vdr-ab-left>\r\n    <vdr-ab-right>\r\n        <vdr-action-bar-items locationId="promotion-list"></vdr-action-bar-items>\r\n        <a class="btn btn-primary"\r\n           *vdrIfPermissions="\'CreatePromotion\'"\r\n           [routerLink]="[\'./create\']">\r\n            <clr-icon shape="plus"></clr-icon>\r\n            {{ \'marketing.create-new-promotion\' | translate }}\r\n        </a>\r\n    </vdr-ab-right>\r\n</vdr-action-bar>\r\n\r\n<vdr-data-table\r\n    [items]="items$ | async"\r\n    [itemsPerPage]="itemsPerPage$ | async"\r\n    [totalItems]="totalItems$ | async"\r\n    [currentPage]="currentPage$ | async"\r\n    (pageChange)="setPageNumber($event)"\r\n    (itemsPerPageChange)="setItemsPerPage($event)"\r\n>\r\n    <vdr-dt-column>{{ \'common.name\' | translate }}</vdr-dt-column>\r\n    <vdr-dt-column>{{ \'marketing.coupon-code\' | translate }}</vdr-dt-column>\r\n    <vdr-dt-column>{{ \'marketing.starts-at\' | translate }}</vdr-dt-column>\r\n    <vdr-dt-column>{{ \'marketing.ends-at\' | translate }}</vdr-dt-column>\r\n    <vdr-dt-column></vdr-dt-column>\r\n    <vdr-dt-column></vdr-dt-column>\r\n    <vdr-dt-column></vdr-dt-column>\r\n    <ng-template let-promotion="item">\r\n        <td class="left align-middle">{{ promotion.name }}</td>\r\n        <td class="left align-middle">\r\n            <vdr-chip *ngIf="promotion.couponCode">\r\n                {{ promotion.couponCode }}\r\n            </vdr-chip>\r\n        </td>\r\n        <td class="left align-middle">{{ promotion.startsAt | localeDate: \'longDate\' }}</td>\r\n        <td class="left align-middle">{{ promotion.endsAt | localeDate: \'longDate\' }}</td>\r\n        <td class="align-middle">\r\n            <vdr-chip *ngIf="!promotion.enabled">{{ \'common.disabled\' | translate }}</vdr-chip>\r\n        </td>\r\n        <td class="right align-middle">\r\n            <vdr-table-row-action\r\n                iconShape="edit"\r\n                [label]="\'common.edit\' | translate"\r\n                [linkTo]="[\'./\', promotion.id]"\r\n            ></vdr-table-row-action>\r\n        </td>\r\n        <td class="right align-middle">\r\n            <vdr-dropdown>\r\n                <button type="button" class="btn btn-link btn-sm" vdrDropdownTrigger>\r\n                    {{ \'common.actions\' | translate }}\r\n                    <clr-icon shape="caret down"></clr-icon>\r\n                </button>\r\n                <vdr-dropdown-menu vdrPosition="bottom-right">\r\n                    <button\r\n                        type="button"\r\n                        class="delete-button"\r\n                        (click)="deletePromotion(promotion.id)"\r\n                        [disabled]="!(\'DeletePromotion\' | hasPermission)"\r\n                        vdrDropdownItem\r\n                    >\r\n                        <clr-icon shape="trash" class="is-danger"></clr-icon>\r\n                        {{ \'common.delete\' | translate }}\r\n                    </button>\r\n                </vdr-dropdown-menu>\r\n            </vdr-dropdown>\r\n        </td>\r\n    </ng-template>\r\n</vdr-data-table>\r\n',changeDetection:r.ChangeDetectionStrategy.OnPush,styles:[".search-form{padding:0}.search-input{margin:6px 8px 0 0;min-width:200px}"]}]}],p.ctorParameters=function(){return[{type:i.DataService},{type:e.Router},{type:e.ActivatedRoute},{type:i.NotificationService},{type:i.ModalService}]};var f=function(n){function r(r,t){return n.call(this,r,{__typename:"Promotion",id:"",createdAt:"",updatedAt:"",name:"",enabled:!1,conditions:[],actions:[]},(function(n){return t.promotion.getPromotion(n).mapStream((function(n){return n.promotion}))}))||this}return d(r,n),r}(i.BaseEntityResolver);f.ɵprov=r.ɵɵdefineInjectable({factory:function(){return new f(r.ɵɵinject(e.Router),r.ɵɵinject(i.DataService))},token:f,providedIn:"root"}),f.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],f.ctorParameters=function(){return[{type:e.Router},{type:i.DataService}]};var v={breadcrumb:o.marker("breadcrumb.promotions")},g={breadcrumb:h},b=[{path:"promotions",component:p,data:v},{path:"promotions/:id",component:u,resolve:i.createResolveData(f),canDeactivate:[i.CanDeactivateDetailGuard],data:g}];function h(n,r){return i.detailBreadcrumb({entity:n.entity,id:r.id,breadcrumbKey:"breadcrumb.promotions",getName:function(n){return n.name},route:"promotions"})}var y=function(){};y.decorators=[{type:r.NgModule,args:[{imports:[i.SharedModule,e.RouterModule.forChild(b)],declarations:[p,u]}]}],n.MarketingModule=y,n.PromotionDetailComponent=u,n.PromotionListComponent=p,n.PromotionResolver=f,n.marketingRoutes=b,n.promotionBreadcrumb=h,n.ɵ0=v,n.ɵ1=g,Object.defineProperty(n,"__esModule",{value:!0})}));
//# sourceMappingURL=vendure-admin-ui-marketing.umd.min.js.map