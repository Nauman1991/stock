import { ChangeDetectionStrategy, ChangeDetectorRef, Component } from '@angular/core';
import { DashboardWidgetService, DataService, LocalStorageService, } from '@vendure/admin-ui/core';
import { assertNever } from '@vendure/common/lib/shared-utils';
import { map, tap } from 'rxjs/operators';
export class DashboardComponent {
    constructor(dashboardWidgetService, localStorageService, changedDetectorRef, dataService) {
        this.dashboardWidgetService = dashboardWidgetService;
        this.localStorageService = localStorageService;
        this.changedDetectorRef = changedDetectorRef;
        this.dataService = dataService;
        this.deletionMarker = '__delete__';
    }
    ngOnInit() {
        this.availableWidgetIds$ = this.dataService.client.userStatus().stream$.pipe(map(({ userStatus }) => userStatus.permissions), map(permissions => this.dashboardWidgetService.getAvailableIds(permissions)), tap(ids => (this.widgetLayout = this.initLayout(ids))));
    }
    getClassForWidth(width) {
        switch (width) {
            case 3:
                return `clr-col-12 clr-col-sm-6 clr-col-lg-3`;
            case 4:
                return `clr-col-12 clr-col-sm-6 clr-col-lg-4`;
            case 6:
                return `clr-col-12 clr-col-lg-6`;
            case 8:
                return `clr-col-12 clr-col-lg-8`;
            case 12:
                return `clr-col-12`;
            default:
                assertNever(width);
        }
    }
    getSupportedWidths(config) {
        return config.supportedWidths || [3, 4, 6, 8, 12];
    }
    setWidgetWidth(widget, width) {
        widget.width = width;
        this.recalculateLayout();
    }
    trackRow(index, row) {
        const id = row.map(item => `${item.id}:${item.width}`).join('|');
        return id;
    }
    trackRowItem(index, item) {
        return item.config;
    }
    addWidget(id) {
        var _a;
        const config = this.dashboardWidgetService.getWidgetById(id);
        if (config) {
            const width = this.getSupportedWidths(config)[0];
            const widget = {
                id,
                config,
                width,
            };
            let targetRow;
            if (this.widgetLayout && this.widgetLayout.length) {
                targetRow = this.widgetLayout[this.widgetLayout.length - 1];
            }
            else {
                targetRow = [];
                (_a = this.widgetLayout) === null || _a === void 0 ? void 0 : _a.push(targetRow);
            }
            targetRow.push(widget);
            this.recalculateLayout();
        }
    }
    removeWidget(widget) {
        widget.id = this.deletionMarker;
        this.recalculateLayout();
    }
    drop(event) {
        const { currentIndex, previousIndex, previousContainer, container } = event;
        if (previousIndex === currentIndex && previousContainer.data.index === container.data.index) {
            // Nothing changed
            return;
        }
        if (this.widgetLayout) {
            const previousLayoutRow = this.widgetLayout[previousContainer.data.index];
            const newLayoutRow = this.widgetLayout[container.data.index];
            previousLayoutRow.splice(previousIndex, 1);
            newLayoutRow.splice(currentIndex, 0, event.item.data);
            this.recalculateLayout();
        }
    }
    initLayout(availableIds) {
        const savedLayoutDef = this.localStorageService.get('dashboardWidgetLayout');
        let layoutDef;
        if (savedLayoutDef) {
            // validate all the IDs from the saved layout are still available
            layoutDef = savedLayoutDef.filter(item => availableIds.includes(item.id));
        }
        return this.dashboardWidgetService.getWidgetLayout(layoutDef);
    }
    recalculateLayout() {
        if (this.widgetLayout) {
            const flattened = this.widgetLayout
                .reduce((flat, row) => [...flat, ...row], [])
                .filter(item => item.id !== this.deletionMarker);
            const newLayoutDef = flattened.map(item => ({
                id: item.id,
                width: item.width,
            }));
            this.widgetLayout = this.dashboardWidgetService.getWidgetLayout(newLayoutDef);
            this.localStorageService.set('dashboardWidgetLayout', newLayoutDef);
            setTimeout(() => this.changedDetectorRef.markForCheck());
        }
    }
}
DashboardComponent.decorators = [
    { type: Component, args: [{
                selector: 'vdr-dashboard',
                template: "<div class=\"widget-header\">\r\n    <vdr-dropdown>\r\n        <button class=\"btn btn-secondary btn-sm\" vdrDropdownTrigger>\r\n            <clr-icon shape=\"plus\"></clr-icon>\r\n            {{ 'dashboard.add-widget' | translate }}\r\n        </button>\r\n        <vdr-dropdown-menu vdrPosition=\"bottom-right\">\r\n            <button\r\n                class=\"button\"\r\n                vdrDropdownItem\r\n                *ngFor=\"let id of availableWidgetIds$ | async\"\r\n                (click)=\"addWidget(id)\"\r\n            >\r\n                {{ id }}\r\n            </button>\r\n        </vdr-dropdown-menu>\r\n    </vdr-dropdown>\r\n</div>\r\n<div cdkDropListGroup>\r\n    <div\r\n        class=\"clr-row dashboard-row\"\r\n        *ngFor=\"let row of widgetLayout; index as rowIndex; trackBy: trackRow\"\r\n        cdkDropList\r\n        (cdkDropListDropped)=\"drop($event)\"\r\n        cdkDropListOrientation=\"horizontal\"\r\n        [cdkDropListData]=\"{ index: rowIndex }\"\r\n    >\r\n        <div\r\n            *ngFor=\"let widget of row; trackBy: trackRowItem\"\r\n            class=\"dashboard-item\"\r\n            [ngClass]=\"getClassForWidth(widget.width)\"\r\n            cdkDrag\r\n            [cdkDragData]=\"widget\"\r\n        >\r\n            <vdr-dashboard-widget\r\n                *vdrIfPermissions=\"widget.config.requiresPermissions || null\"\r\n                [widgetConfig]=\"widget.config\"\r\n            >\r\n                <div class=\"flex\">\r\n                    <div class=\"drag-handle\" cdkDragHandle>\r\n                        <clr-icon shape=\"drag-handle\" size=\"24\"></clr-icon>\r\n                    </div>\r\n                    <vdr-dropdown>\r\n                        <button class=\"icon-button\" vdrDropdownTrigger>\r\n                            <clr-icon shape=\"ellipsis-vertical\"></clr-icon>\r\n                        </button>\r\n                        <vdr-dropdown-menu vdrPosition=\"bottom-right\">\r\n                            <h4 class=\"dropdown-header\">{{ 'dashboard.widget-resize' | translate }}</h4>\r\n                            <button\r\n                                class=\"button\"\r\n                                vdrDropdownItem\r\n                                [disabled]=\"width === widget.width\"\r\n                                *ngFor=\"let width of getSupportedWidths(widget.config)\"\r\n                                (click)=\"setWidgetWidth(widget, width)\"\r\n                            >\r\n                                {{ 'dashboard.widget-width' | translate: { width: width } }}\r\n                            </button>\r\n                            <div class=\"dropdown-divider\" role=\"separator\"></div>\r\n                            <button class=\"button\" vdrDropdownItem (click)=\"removeWidget(widget)\">\r\n                                <clr-icon shape=\"trash\" class=\"is-danger\"></clr-icon>\r\n                                {{ 'dashboard.remove-widget' | translate }}\r\n                            </button>\r\n                        </vdr-dropdown-menu>\r\n                    </vdr-dropdown>\r\n                </div>\r\n            </vdr-dashboard-widget>\r\n        </div>\r\n    </div>\r\n</div>\r\n",
                changeDetection: ChangeDetectionStrategy.OnPush,
                styles: [".widget-header{display:flex;justify-content:flex-end}.placeholder{color:var(--color-grey-300);text-align:center}.placeholder .version{font-size:3em;margin:24px;line-height:1em}.placeholder ::ng-deep .clr-i-outline{fill:var(--color-grey-200)}vdr-dashboard-widget{margin-bottom:24px}.cdk-drag-preview{box-sizing:border-box;border-radius:4px}.cdk-drag-placeholder{opacity:0}.cdk-drag-animating{transition:transform .25s cubic-bezier(0,0,.2,1)}.dashboard-row{padding:0;border-width:1;margin-bottom:6px;transition:padding .2s,margin .2s}.dashboard-row.cdk-drop-list-dragging,.dashboard-row.cdk-drop-list-receiving{border:1px dashed var(--color-component-border-200);padding:6px}.dashboard-row.cdk-drop-list-dragging .dashboard-item:not(.cdk-drag-placeholder){transition:transform .25s cubic-bezier(0,0,.2,1)}"]
            },] }
];
DashboardComponent.ctorParameters = () => [
    { type: DashboardWidgetService },
    { type: LocalStorageService },
    { type: ChangeDetectorRef },
    { type: DataService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGFzaGJvYXJkLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9saWIvZGFzaGJvYXJkL3NyYy9jb21wb25lbnRzL2Rhc2hib2FyZC9kYXNoYm9hcmQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQVUsTUFBTSxlQUFlLENBQUM7QUFDOUYsT0FBTyxFQUVILHNCQUFzQixFQUV0QixXQUFXLEVBQ1gsbUJBQW1CLEdBR3RCLE1BQU0sd0JBQXdCLENBQUM7QUFDaEMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBRS9ELE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFRMUMsTUFBTSxPQUFPLGtCQUFrQjtJQUszQixZQUNZLHNCQUE4QyxFQUM5QyxtQkFBd0MsRUFDeEMsa0JBQXFDLEVBQ3JDLFdBQXdCO1FBSHhCLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBd0I7UUFDOUMsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtRQUN4Qyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW1CO1FBQ3JDLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBTm5CLG1CQUFjLEdBQUcsWUFBWSxDQUFDO0lBTzVDLENBQUM7SUFFSixRQUFRO1FBQ0osSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQ3hFLEdBQUcsQ0FBQyxDQUFDLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsRUFDL0MsR0FBRyxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLGVBQWUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxF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QUFHLENBQUMsRUFBRSxFQUFFLENBQUM7aUJBQzVDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQ3JELE1BQU0sWUFBWSxHQUEyQixTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDaEUsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFO2dCQUNYLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSzthQUNwQixDQUFDLENBQUMsQ0FBQztZQUNKLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDLGVBQWUsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUM5RSxJQUFJLENBQUMsbUJBQW1CLENBQUMsR0FBRyxDQUFDLHVCQUF1QixFQUFFLFlBQVksQ0FBQyxDQUFDO1lBQ3BFLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQztTQUM1RDtJQUNMLENBQUM7OztZQTlISixTQUFTLFNBQUM7Z0JBQ1AsUUFBUSxFQUFFLGVBQWU7Z0JBQ3pCLDhyR0FBeUM7Z0JBRXpDLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNOzthQUNsRDs7O1lBaEJHLHNCQUFzQjtZQUd0QixtQkFBbUI7WUFOVyxpQkFBaUI7WUFLL0MsV0FBVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENka0RyYWdEcm9wIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2RyYWctZHJvcCc7XHJcbmltcG9ydCB7IENoYW5nZURldGVjdGlvblN0cmF0ZWd5LCBDaGFuZ2VEZXRlY3RvclJlZiwgQ29tcG9uZW50LCBPbkluaXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHtcclxuICAgIERhc2hib2FyZFdpZGdldENvbmZpZyxcclxuICAgIERhc2hib2FyZFdpZGdldFNlcnZpY2UsXHJcbiAgICBEYXNoYm9hcmRXaWRnZXRXaWR0aCxcclxuICAgIERhdGFTZXJ2aWNlLFxyXG4gICAgTG9jYWxTdG9yYWdlU2VydmljZSxcclxuICAgIFdpZGdldExheW91dCxcclxuICAgIFdpZGdldExheW91dERlZmluaXRpb24sXHJcbn0gZnJvbSAnQHZlbmR1cmUvYWRtaW4tdWkvY29yZSc7XHJcbmltcG9ydCB7IGFzc2VydE5ldmVyIH0gZnJvbSAnQHZlbmR1cmUvY29tbW9uL2xpYi9zaGFyZWQtdXRpbHMnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IG1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgICBzZWxlY3RvcjogJ3Zkci1kYXNoYm9hcmQnLFxyXG4gICAgdGVtcGxhdGVVcmw6ICcuL2Rhc2hib2FyZC5jb21wb25lbnQuaHRtbCcsXHJcbiAgICBzdHlsZVVybHM6IFsnLi9kYXNoYm9hcmQuY29tcG9uZW50LnNjc3MnXSxcclxuICAgIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgRGFzaGJvYXJkQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcclxuICAgIHdpZGdldExheW91dDogV2lkZ2V0TGF5b3V0IHwgdW5kZWZpbmVkO1xyXG4gICAgYXZhaWxhYmxlV2lkZ2V0SWRzJDogT2JzZXJ2YWJsZTxzdHJpbmdbXT47XHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGRlbGV0aW9uTWFya2VyID0gJ19fZGVsZXRlX18nO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHByaXZhdGUgZGFzaGJvYXJkV2lkZ2V0U2VydmljZTogRGFzaGJvYXJkV2lkZ2V0U2VydmljZSxcclxuICAgICAgICBwcml2YXRlIGxvY2FsU3RvcmFnZVNlcnZpY2U6IExvY2FsU3RvcmFnZVNlcnZpY2UsXHJcbiAgICAgICAgcHJpdmF0ZSBjaGFuZ2VkRGV0ZWN0b3JSZWY6IENoYW5nZURldGVjdG9yUmVmLFxyXG4gICAgICAgIHByaXZhdGUgZGF0YVNlcnZpY2U6IERhdGFTZXJ2aWNlLFxyXG4gICAgKSB7fVxyXG5cclxuICAgIG5nT25Jbml0KCkge1xyXG4gICAgICAgIHRoaXMuYXZhaWxhYmxlV2lkZ2V0SWRzJCA9IHRoaXMuZGF0YVNlcnZpY2UuY2xpZW50LnVzZXJTdGF0dXMoKS5zdHJlYW0kLnBpcGUoXHJcbiAgICAgICAgICAgIG1hcCgoeyB1c2VyU3RhdHVzIH0pID0+IHVzZXJTdGF0dXMucGVybWlzc2lvbnMpLFxyXG4gICAgICAgICAgICBtYXAocGVybWlzc2lvbnMgPT4gdGhpcy5kYXNoYm9hcmRXaWRnZXRTZXJ2aWNlLmdldEF2YWlsYWJsZUlkcyhwZXJtaXNzaW9ucykpLFxyXG4gICAgICAgICAgICB0YXAoaWRzID0+ICh0aGlzLndpZGdldExheW91dCA9IHRoaXMuaW5pdExheW91dChpZHMpKSksXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRDbGFzc0ZvcldpZHRoKHdpZHRoOiBEYXNoYm9hcmRXaWRnZXRXaWR0aCk6IHN0cmluZyB7XHJcbiAgICAgICAgc3dpdGNoICh3aWR0aCkge1xyXG4gICAgICAgICAgICBjYXNlIDM6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYGNsci1jb2wtMTIgY2xyLWNvbC1zbS02IGNsci1jb2wtbGctM2A7XHJcbiAgICAgICAgICAgIGNhc2UgNDpcclxuICAgICAgICAgICAgICAgIHJldHVybiBgY2xyLWNvbC0xMiBjbHItY29sLXNtLTYgY2xyLWNvbC1sZy00YDtcclxuICAgICAgICAgICAgY2FzZSA2OlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGBjbHItY29sLTEyIGNsci1jb2wtbGctNmA7XHJcbiAgICAgICAgICAgIGNhc2UgODpcclxuICAgICAgICAgICAgICAgIHJldHVybiBgY2xyLWNvbC0xMiBjbHItY29sLWxnLThgO1xyXG4gICAgICAgICAgICBjYXNlIDEyOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGBjbHItY29sLTEyYDtcclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIGFzc2VydE5ldmVyKHdpZHRoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0U3VwcG9ydGVkV2lkdGhzKGNvbmZpZzogRGFzaGJvYXJkV2lkZ2V0Q29uZmlnKTogRGFzaGJvYXJkV2lkZ2V0V2lkdGhbXSB7XHJcbiAgICAgICAgcmV0dXJuIGNvbmZpZy5zdXBwb3J0ZWRXaWR0aHMgfHwgWzMsIDQsIDYsIDgsIDEyXTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRXaWRnZXRXaWR0aCh3aWRnZXQ6IFdpZGdldExheW91dFtudW1iZXJdW251bWJlcl0sIHdpZHRoOiBEYXNoYm9hcmRXaWRnZXRXaWR0aCkge1xyXG4gICAgICAgIHdpZGdldC53aWR0aCA9IHdpZHRoO1xyXG4gICAgICAgIHRoaXMucmVjYWxjdWxhdGVMYXlvdXQoKTtcclxuICAgIH1cclxuXHJcbiAgICB0cmFja1JvdyhpbmRleDogbnVtYmVyLCByb3c6IFdpZGdldExheW91dFtudW1iZXJdKSB7XHJcbiAgICAgICAgY29uc3QgaWQgPSByb3cubWFwKGl0ZW0gPT4gYCR7aXRlbS5pZH06JHtpdGVtLndpZHRofWApLmpvaW4oJ3wnKTtcclxuICAgICAgICByZXR1cm4gaWQ7XHJcbiAgICB9XHJcblxyXG4gICAgdHJhY2tSb3dJdGVtKGluZGV4OiBudW1iZXIsIGl0ZW06IFdpZGdldExheW91dFtudW1iZXJdW251bWJlcl0pIHtcclxuICAgICAgICByZXR1cm4gaXRlbS5jb25maWc7XHJcbiAgICB9XHJcblxyXG4gICAgYWRkV2lkZ2V0KGlkOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBjb25maWcgPSB0aGlzLmRhc2hib2FyZFdpZGdldFNlcnZpY2UuZ2V0V2lkZ2V0QnlJZChpZCk7XHJcbiAgICAgICAgaWYgKGNvbmZpZykge1xyXG4gICAgICAgICAgICBjb25zdCB3aWR0aCA9IHRoaXMuZ2V0U3VwcG9ydGVkV2lkdGhzKGNvbmZpZylbMF07XHJcbiAgICAgICAgICAgIGNvbnN0IHdpZGdldDogV2lkZ2V0TGF5b3V0W251bWJlcl1bbnVtYmVyXSA9IHtcclxuICAgICAgICAgICAgICAgIGlkLFxyXG4gICAgICAgICAgICAgICAgY29uZmlnLFxyXG4gICAgICAgICAgICAgICAgd2lkdGgsXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIGxldCB0YXJnZXRSb3c6IFdpZGdldExheW91dFtudW1iZXJdO1xyXG4gICAgICAgICAgICBpZiAodGhpcy53aWRnZXRMYXlvdXQgJiYgdGhpcy53aWRnZXRMYXlvdXQubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICB0YXJnZXRSb3cgPSB0aGlzLndpZGdldExheW91dFt0aGlzLndpZGdldExheW91dC5sZW5ndGggLSAxXTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRhcmdldFJvdyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgdGhpcy53aWRnZXRMYXlvdXQ/LnB1c2godGFyZ2V0Um93KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0YXJnZXRSb3cucHVzaCh3aWRnZXQpO1xyXG4gICAgICAgICAgICB0aGlzLnJlY2FsY3VsYXRlTGF5b3V0KCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJlbW92ZVdpZGdldCh3aWRnZXQ6IFdpZGdldExheW91dFtudW1iZXJdW251bWJlcl0pIHtcclxuICAgICAgICB3aWRnZXQuaWQgPSB0aGlzLmRlbGV0aW9uTWFya2VyO1xyXG4gICAgICAgIHRoaXMucmVjYWxjdWxhdGVMYXlvdXQoKTtcclxuICAgIH1cclxuXHJcbiAgICBkcm9wKGV2ZW50OiBDZGtEcmFnRHJvcDx7IGluZGV4OiBudW1iZXIgfT4pIHtcclxuICAgICAgICBjb25zdCB7IGN1cnJlbnRJbmRleCwgcHJldmlvdXNJbmRleCwgcHJldmlvdXNDb250YWluZXIsIGNvbnRhaW5lciB9ID0gZXZlbnQ7XHJcbiAgICAgICAgaWYgKHByZXZpb3VzSW5kZXggPT09IGN1cnJlbnRJbmRleCAmJiBwcmV2aW91c0NvbnRhaW5lci5kYXRhLmluZGV4ID09PSBjb250YWluZXIuZGF0YS5pbmRleCkge1xyXG4gICAgICAgICAgICAvLyBOb3RoaW5nIGNoYW5nZWRcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy53aWRnZXRMYXlvdXQpIHtcclxuICAgICAgICAgICAgY29uc3QgcHJldmlvdXNMYXlvdXRSb3cgPSB0aGlzLndpZGdldExheW91dFtwcmV2aW91c0NvbnRhaW5lci5kYXRhLmluZGV4XTtcclxuICAgICAgICAgICAgY29uc3QgbmV3TGF5b3V0Um93ID0gdGhpcy53aWRnZXRMYXlvdXRbY29udGFpbmVyLmRhdGEuaW5kZXhdO1xyXG5cclxuICAgICAgICAgICAgcHJldmlvdXNMYXlvdXRSb3cuc3BsaWNlKHByZXZpb3VzSW5kZXgsIDEpO1xyXG4gICAgICAgICAgICBuZXdMYXlvdXRSb3cuc3BsaWNlKGN1cnJlbnRJbmRleCwgMCwgZXZlbnQuaXRlbS5kYXRhKTtcclxuICAgICAgICAgICAgdGhpcy5yZWNhbGN1bGF0ZUxheW91dCgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGluaXRMYXlvdXQoYXZhaWxhYmxlSWRzOiBzdHJpbmdbXSk6IFdpZGdldExheW91dCB7XHJcbiAgICAgICAgY29uc3Qgc2F2ZWRMYXlvdXREZWYgPSB0aGlzLmxvY2FsU3RvcmFnZVNlcnZpY2UuZ2V0KCdkYXNoYm9hcmRXaWRnZXRMYXlvdXQnKTtcclxuICAgICAgICBsZXQgbGF5b3V0RGVmOiBXaWRnZXRMYXlvdXREZWZpbml0aW9uIHwgdW5kZWZpbmVkO1xyXG4gICAgICAgIGlmIChzYXZlZExheW91dERlZikge1xyXG4gICAgICAgICAgICAvLyB2YWxpZGF0ZSBhbGwgdGhlIElEcyBmcm9tIHRoZSBzYXZlZCBsYXlvdXQgYXJlIHN0aWxsIGF2YWlsYWJsZVxyXG4gICAgICAgICAgICBsYXlvdXREZWYgPSBzYXZlZExheW91dERlZi5maWx0ZXIoaXRlbSA9PiBhdmFpbGFibGVJZHMuaW5jbHVkZXMoaXRlbS5pZCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5kYXNoYm9hcmRXaWRnZXRTZXJ2aWNlLmdldFdpZGdldExheW91dChsYXlvdXREZWYpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVjYWxjdWxhdGVMYXlvdXQoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMud2lkZ2V0TGF5b3V0KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGZsYXR0ZW5lZCA9IHRoaXMud2lkZ2V0TGF5b3V0XHJcbiAgICAgICAgICAgICAgICAucmVkdWNlKChmbGF0LCByb3cpID0+IFsuLi5mbGF0LCAuLi5yb3ddLCBbXSlcclxuICAgICAgICAgICAgICAgIC5maWx0ZXIoaXRlbSA9PiBpdGVtLmlkICE9PSB0aGlzLmRlbGV0aW9uTWFya2VyKTtcclxuICAgICAgICAgICAgY29uc3QgbmV3TGF5b3V0RGVmOiBXaWRnZXRMYXlvdXREZWZpbml0aW9uID0gZmxhdHRlbmVkLm1hcChpdGVtID0+ICh7XHJcbiAgICAgICAgICAgICAgICBpZDogaXRlbS5pZCxcclxuICAgICAgICAgICAgICAgIHdpZHRoOiBpdGVtLndpZHRoLFxyXG4gICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgIHRoaXMud2lkZ2V0TGF5b3V0ID0gdGhpcy5kYXNoYm9hcmRXaWRnZXRTZXJ2aWNlLmdldFdpZGdldExheW91dChuZXdMYXlvdXREZWYpO1xyXG4gICAgICAgICAgICB0aGlzLmxvY2FsU3RvcmFnZVNlcnZpY2Uuc2V0KCdkYXNoYm9hcmRXaWRnZXRMYXlvdXQnLCBuZXdMYXlvdXREZWYpO1xyXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuY2hhbmdlZERldGVjdG9yUmVmLm1hcmtGb3JDaGVjaygpKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuIl19